<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin Pulse | Mindful Design</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #a78bfa 0%, #f472b6 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            background-color: #0f172a;
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- AURORA BACKGROUND ANIMATION --- */
        .aurora-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #4c1d95; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #be185d; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #0f766e; animation-delay: 4s; opacity: 0.4; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }

        /* --- GLASS UI --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
        }

        /* --- TYPOGRAPHY --- */
        .serif-font { font-family: 'Playfair Display', serif; }
        
        /* --- SOFT INPUTS --- */
        .soft-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        .soft-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #f472b6;
            outline: none;
            box-shadow: 0 0 15px rgba(244, 114, 182, 0.2);
        }

        /* --- SELECT DROPDOWN STYLING --- */
        select.soft-input option,
        select option {
            background-color: #1e293b;
            color: white;
            padding: 8px;
        }
        
        select.soft-input,
        select {
            color: white;
            background-color: rgba(30, 41, 59, 0.8);
        }

        /* --- BUTTONS --- */
        .gradient-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 500;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.3);
        }
        .gradient-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(167, 139, 250, 0.5);
            filter: brightness(1.1);
        }
        .gradient-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(0.8); }

        .outline-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-muted);
            transition: all 0.3s;
        }
        .outline-btn:hover { background: rgba(255,255,255,0.05); color: white; border-color: white; }

        /* --- EMOJIS & TABS --- */
        .emoji-btn { 
            filter: grayscale(100%) opacity(0.4); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 1.6rem; 
        }
        .emoji-btn:hover, .emoji-btn.selected { 
            filter: grayscale(0%) opacity(1); 
            transform: scale(1.25); 
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- WILLPOWER METER --- */
        .meter-bg { background: #1e293b; border-radius: 99px; height: 8px; overflow: hidden; }
        .meter-fill { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- GLOWING BUTTON --- */
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.5), 0 0 40px rgba(167, 139, 250, 0.3); }
            50% { box-shadow: 0 0 30px rgba(167, 139, 250, 0.7), 0 0 60px rgba(167, 139, 250, 0.5); }
        }
        .btn-glow-ready {
            animation: glow-pulse 2s infinite ease-in-out;
            border: 2px solid rgba(167, 139, 250, 0.6);
        }

        /* --- TOAST NOTIFICATIONS --- */
        .toast {
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
            max-width: 400px;
        }
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* --- CONFETTI ANIMATION --- */
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 999;
            animation: confetti-fall 3s linear forwards;
        }

        /* --- BADGE ANIMATIONS --- */
        .badge-unlock {
            animation: badgeUnlock 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes badgeUnlock {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 md:p-8">

    <div id="toast-container" class="fixed bottom-6 right-6 z-[1000] space-y-3"></div>

    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>

    <div id="auth-screen" class="w-full max-w-sm z-50 animate__animated animate__fadeIn">
        <div class="glass-card rounded-3xl p-10 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-fuchsia-500/20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-violet-500/20 rounded-full blur-3xl"></div>
            
            <div class="text-center mb-8 relative z-10">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-2xl mb-4 shadow-lg shadow-violet-500/30">
                    <i class="fa-solid fa-heart-pulse text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-violet-300 to-fuchsia-300 bg-clip-text text-transparent">Twin Pulse</h1>
                <p class="text-xs text-slate-400 tracking-wider">Mindful Finance & Focus</p>
            </div>

            <div id="login-form" class="relative z-10">
                <form onsubmit="Auth.login(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-2 ml-2">Email</label>
                            <input type="email" id="log-email" placeholder="your@email.com" class="w-full soft-input p-3 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-2 ml-2">Password</label>
                            <input type="password" id="log-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full soft-input p-3 rounded-xl text-sm" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 gradient-btn rounded-xl text-sm mt-6">
                        <i class="fa-solid fa-arrow-right mr-2"></i>Sign In
                    </button>
                </form>
                <p id="login-msg" class="text-center text-xs mt-4"></p>
                <button onclick="Auth.toggle()" class="w-full mt-4 text-xs text-slate-400 hover:text-white transition-colors">
                    Don't have an account? <span class="text-fuchsia-300">Sign Up</span>
                </button>
                
                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/10"></div>
                    </div>
                    <div class="relative flex justify-center text-xs">
                        <span class="px-2 bg-[#0f172a] text-slate-500">OR</span>
                    </div>
                </div>
                
                <button onclick="Auth.demoLogin()" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 text-white rounded-xl text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-rocket"></i>
                    Try Demo Mode
                </button>
            </div>

            <div id="signup-form" class="hidden relative z-10">
                <form onsubmit="Auth.signup(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-2 ml-2">Full Name</label>
                            <input type="text" id="sign-name" placeholder="John Doe" class="w-full soft-input p-3 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-2 ml-2">Email</label>
                            <input type="email" id="sign-email" placeholder="your@email.com" class="w-full soft-input p-3 rounded-xl text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-2 ml-2">Password</label>
                            <input type="password" id="sign-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full soft-input p-3 rounded-xl text-sm" required>
                        </div>
                    </div>
                    <button type="submit" onclick="console.log('Button clicked!')" class="w-full py-3 gradient-btn rounded-xl text-sm mt-6">
                        <i class="fa-solid fa-user-plus mr-2"></i>Create Account
                    </button>
                </form>
                <p id="signup-msg" class="text-center text-xs mt-4"></p>
                <button onclick="Auth.toggle()" class="w-full mt-4 text-xs text-slate-400 hover:text-white transition-colors">
                    Already have an account? <span class="text-fuchsia-300">Sign In</span>
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden w-full max-w-7xl animate__animated animate__fadeIn pb-12">
        
        <nav class="glass-card rounded-2xl px-6 py-4 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-40 bg-opacity-80">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-violet-500 to-fuchsia-500 flex items-center justify-center text-white text-sm font-bold shadow-lg">
                    <span id="user-initial">U</span>
                </div>
                <div>
                    <h2 id="display-name" class="text-white text-lg font-medium">Welcome</h2>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">System Ready</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="Tutorial.show()" class="w-9 h-9 rounded-full bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 flex items-center justify-center text-blue-400 hover:text-blue-300 transition-all group" title="Help & Shortcuts">
                    <i class="fa-solid fa-circle-question text-lg group-hover:scale-110 transition-transform"></i>
                </button>
                <div class="flex items-center gap-2 bg-slate-900/40 px-3 py-2 rounded-full border border-white/5">
                    <i class="fa-solid fa-microchip text-violet-400 text-[10px]"></i>
                    <select id="model-select" class="bg-slate-800 text-white text-xs outline-none cursor-pointer border-r border-white/10 pr-2 rounded px-1 py-0.5" onchange="CONFIG.model = this.value; console.log('Model changed to:', this.value)">
                        <option value="gemini-2.5-flash" selected>Flash 2.5 ‚ö°</option>
                        <option value="gemini-1.5-flash">Flash 1.5</option>
                        <option value="gemini-1.5-pro">Pro 1.5</option>
                        <option value="gemini-2.0-flash-exp">Flash 2.0 (Exp)</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/40 px-4 py-2 rounded-full border border-white/5">
                    <i class="fa-solid fa-key text-pink-400 text-[10px]"></i>
                    <input type="password" id="api-key" placeholder="Gemini API Key" class="bg-transparent text-white text-xs outline-none w-32 text-center">
                </div>
                <button onclick="Auth.logout()" class="text-xs text-slate-500 hover:text-red-400 transition-colors">Logout</button>
            </div>
        </nav>

        
        <div class="glass-card rounded-2xl p-6 mb-8 animate__animated animate__fadeInDown">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-emerald-400" id="stat-saved">‚Çπ0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider mt-1">Total Saved</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-rose-400" id="stat-declined">0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider mt-1">Declined</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-violet-400" id="stat-streak">0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider mt-1">Day Streak üî•</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-400" id="stat-success">0%</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider mt-1">Success Rate</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-7 space-y-6">
                
                <div class="glass-card rounded-3xl p-8 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20"></div>
                    <div class="flex flex-col md:flex-row gap-8 justify-between items-center relative z-10">
                        <div class="w-full">
                            <label class="text-xs text-slate-400 uppercase tracking-wider mb-1 block">Current Balance</label>
                            <div class="flex items-baseline gap-1">
                                <span class="text-2xl text-slate-500 font-light">‚Çπ</span>
                                <input type="number" id="fin-bal" value="10000" class="bg-transparent text-4xl font-light text-white w-full outline-none" onchange="Finance.updateSafe()">
                            </div>
                        </div>
                        <div class="w-[1px] h-12 bg-white/10 hidden md:block"></div>
                        <div class="w-full">
                            <label class="text-xs text-pink-400 uppercase tracking-wider mb-1 block">Savings Goal</label>
                            <div class="flex items-baseline gap-1">
                                <span class="text-2xl text-slate-500 font-light">‚Çπ</span>
                                <input type="number" id="fin-goal" value="2000" class="bg-transparent text-4xl font-light text-pink-300 w-full outline-none" onchange="Finance.updateSafe()">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center">
                        <span class="text-xs text-slate-500">Available for Spending</span>
                        <span id="fin-safe" class="text-lg font-medium text-emerald-400">‚Çπ8000</span>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <h3 class="text-white/80 text-sm font-medium mb-6">How are you feeling?</h3>
                    <div class="flex justify-between px-2 mb-8">
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="Finance.setMood(this, 'Happy')" class="emoji-btn">üòÉ</button>
                            <span class="text-[10px] text-slate-500">Happy</span>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="Finance.setMood(this, 'Excited')" class="emoji-btn">ü§©</button>
                            <span class="text-[10px] text-slate-500">Excited</span>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="Finance.setMood(this, 'Neutral')" class="emoji-btn selected">üòê</button>
                            <span class="text-[10px] text-slate-500">Neutral</span>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="Finance.setMood(this, 'Stressed')" class="emoji-btn">üò´</button>
                            <span class="text-[10px] text-slate-500">Stressed</span>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button onclick="Finance.setMood(this, 'Sad')" class="emoji-btn">üò¢</button>
                            <span class="text-[10px] text-slate-500">Sad</span>
                        </div>
                    </div>
                    <input type="hidden" id="fin-mood" value="Neutral">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs text-slate-400 ml-2">Location / Vibe <span class="text-[10px] text-slate-500">(affects spending decision)</span></label>
                            <div class="relative">
                                <i class="fa-solid fa-location-dot absolute left-4 top-4 text-slate-500 text-xs"></i>
                                <select id="fin-loc" class="w-full soft-input p-3 pl-10 rounded-2xl text-sm appearance-none cursor-pointer">
                                    <option value="Home">üè† Relaxing at Home</option>
                                    <option value="Online Late Night">üåö Late Night Browsing</option>
                                    <option value="Shopping Mall">üõçÔ∏è Shopping Mall</option>
                                    <option value="Electronics Store">üì± Tech Store</option>
                                    <option value="Restaurant/Bar">üç∑ Social Outing</option>
                                    <option value="Travel">‚úàÔ∏è Travel</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-slate-400 ml-2">Hourly Wage <span class="text-[10px] text-slate-500">(‚Çπ/hour)</span></label>
                            <div class="relative">
                                <i class="fa-solid fa-coins absolute left-4 top-4 text-slate-500 text-xs"></i>
                                <input type="number" id="fin-wage" value="100" class="w-full soft-input p-3 pl-10 rounded-2xl text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div class="flex gap-2 mb-6">
                        <button onclick="Finance.toggleMode('visual')" id="btn-mode-vis" class="flex-1 py-3 rounded-xl bg-white/10 text-white font-medium text-xs uppercase tracking-wider transition-all border border-white/10">
                            <i class="fa-solid fa-camera mr-2"></i>Visual
                        </button>
                        <button onclick="Finance.toggleMode('text')" id="btn-mode-txt" class="flex-1 py-3 rounded-xl text-slate-400 font-medium text-xs uppercase tracking-wider transition-all">
                            <i class="fa-solid fa-keyboard mr-2"></i>Manual
                        </button>
                    </div>

                    <div id="mode-visual">
                        <div class="relative bg-slate-900/30 rounded-2xl overflow-hidden border border-white/5" style="min-height: 250px;">
                            <div id="visual-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                                <i class="fa-solid fa-image text-4xl mb-3"></i>
                                <p class="text-sm">Upload or capture image</p>
                            </div>
                            <img id="display-image" class="hidden w-full h-full object-cover rounded-2xl">
                            <video id="camera-feed" class="hidden w-full h-64 object-cover" autoplay playsinline></video>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <label class="flex-1 py-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl text-center cursor-pointer border border-white/5 transition-all">
                                <i class="fa-solid fa-upload mr-2 text-slate-400"></i>
                                <span class="text-sm text-slate-300">Upload</span>
                                <input type="file" accept="image/*" class="hidden" onchange="Finance.handleUpload(this)">
                            </label>
                            <button onclick="Finance.startCamera()" class="flex-1 py-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-white/5 transition-all">
                                <i class="fa-solid fa-camera mr-2 text-slate-400"></i>
                                <span class="text-sm text-slate-300">Camera</span>
                            </button>
                            <button onclick="Finance.snapPhoto()" id="btn-capture" class="hidden flex-1 py-3 bg-fuchsia-500 hover:bg-fuchsia-400 rounded-xl text-white font-medium transition-all">
                                Capture
                            </button>
                        </div>
                    </div>

                    <div id="mode-text" class="hidden space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 ml-2 mb-2 block">Item Name</label>
                            <input type="text" id="man-name" placeholder="e.g., Nike Shoes" class="w-full soft-input p-3 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 ml-2 mb-2 block">Price (‚Çπ)</label>
                            <input type="number" id="man-price" placeholder="e.g., 5000" class="w-full soft-input p-3 rounded-xl text-sm">
                        </div>
                    </div>

                    <button onclick="Finance.analyze()" id="btn-fin-analyze" class="w-full py-4 gradient-btn rounded-2xl text-sm mt-6 uppercase tracking-wider">
                        Analyze Decision
                    </button>
                </div>

                <div id="fin-idle" class="glass-card rounded-3xl p-8 text-center">
                    <i class="fa-solid fa-circle-notch text-4xl text-slate-700 mb-4"></i>
                    <p class="text-sm text-slate-500">Ready to analyze your purchase decision</p>
                </div>

                <div id="fin-result" class="hidden glass-card rounded-3xl p-8 space-y-6 animate__animated animate__fadeInUp">
                    <div class="pb-6 border-b border-white/10">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 id="res-name" class="text-2xl font-medium text-white mb-2">--</h3>
                                <p id="res-price" class="text-4xl font-light text-fuchsia-300">‚Çπ--</p>
                            </div>
                            <span id="res-badge" class="px-4 py-2 rounded-full text-xs font-bold uppercase">--</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-slate-400">
                            <i class="fa-solid fa-clock"></i>
                            <span id="res-time-cost">--</span>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs text-slate-400 uppercase font-bold tracking-wider">Impulse Risk Analysis</span>
                            <span id="res-risk-val" class="text-lg font-bold text-white">--%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden mb-2">
                            <div id="res-risk-bar" class="h-full bg-gradient-to-r from-violet-400 to-fuchsia-400 transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500">Based on mood, location, and financial context</p>
                    </div>

                    <div class="bg-white/5 border border-white/10 p-6 rounded-2xl">
                        <div class="flex items-start gap-3 mb-3">
                            <i class="fa-solid fa-lightbulb text-violet-400 text-xl"></i>
                            <div class="flex-1">
                                <h4 class="text-xs uppercase font-bold text-violet-400 mb-2 tracking-wider">Financial Guidance</h4>
                                <p id="res-reason" class="text-sm text-slate-200 leading-relaxed serif-font italic">--</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="Finance.confirm()" id="btn-confirm" class="w-full py-4 rounded-2xl text-sm uppercase tracking-wider transition-all font-medium">
                        Confirm Purchase
                    </button>
                </div>
            </div>

            <div class="lg:col-span-5 space-y-6">
                
                
                <div class="glass-card rounded-3xl p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-medium text-white/80">
                            <i class="fa-solid fa-brain mr-2 text-purple-400"></i>Focus & Willpower
                        </h3>
                        <button onclick="Focus.calculate()" id="btn-focus" class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 rounded-lg text-purple-400 text-xs font-bold transition-all">
                            Calculate
                        </button>
                    </div>
                    
                    <div class="mb-6 p-5 bg-slate-900/50 rounded-xl border border-slate-800">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs uppercase text-slate-400">Willpower Score</span>
                            <span id="willpower-score" class="text-2xl font-bold text-purple-400">--</span>
                        </div>
                        <div class="meter-bg">
                            <div id="willpower-bar" class="meter-fill bg-gradient-to-r from-purple-500 to-pink-500" style="width: 0%"></div>
                        </div>
                        <div id="willpower-status" class="text-xs text-slate-500 mt-2 italic">Enter your daily data below</div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 mb-2 block ml-2">Current Task / Goal</label>
                            <input type="text" id="current-task" placeholder="e.g., Complete project proposal" class="w-full soft-input p-3 rounded-xl text-sm" oninput="Focus.checkReady()">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-400 mb-2 block ml-2">
                                    <i class="fa-solid fa-bed mr-1"></i>Sleep (hrs) <span class="text-slate-400 text-[10px]">(optional)</span>
                                </label>
                                <input type="number" id="sleep-hours" placeholder="7" min="0" max="12" step="0.5" class="soft-input rounded-xl px-3 py-2.5 text-sm w-full text-center">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 mb-2 block ml-2">
                                    <i class="fa-solid fa-burst mr-1"></i>Bad Decisions <span class="text-slate-400 text-[10px]">(optional)</span>
                                </label>
                                <input type="number" id="bad-decisions" placeholder="0" min="0" class="soft-input rounded-xl px-3 py-2.5 text-sm w-full text-center">
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-xs text-slate-400 mb-2 block ml-2">
                                <i class="fa-solid fa-list-check mr-1"></i>Tasks Done / Total
                            </label>
                            <div class="flex gap-2">
                                <input type="number" id="tasks-completed" placeholder="5" min="0" class="soft-input rounded-xl px-3 py-2.5 text-sm flex-1 text-center">
                                <span class="text-slate-500 flex items-center">/</span>
                                <input type="number" id="tasks-total" placeholder="10" min="1" class="soft-input rounded-xl px-3 py-2.5 text-sm flex-1 text-center">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-slate-400 mb-2 block ml-2">Previous Activity</label>
                            <select id="prev-activity" class="w-full soft-input p-3 rounded-xl text-sm cursor-pointer">
                                <option value="Doomscrolling">üì± Doomscrolling (Socials)</option>
                                <option value="Deep Work">üß† Deep Focus / Work</option>
                                <option value="Gaming">üéÆ High Stimulation (Gaming)</option>
                                <option value="Streaming">üì∫ Passive Watching</option>
                                <option value="Sleeping">üò¥ Sleep / Nap</option>
                                <option value="Exercise">üí™ Physical Exercise</option>
                                <option value="Eating">ü•ó Eating</option>
                            </select>
                        </div>
                        
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs text-slate-400 ml-2">Energy Level</label>
                                <span id="lbl-energy" class="text-violet-300 font-medium text-sm">50%</span>
                            </div>
                            <input type="range" id="energy-level" value="50" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-violet-500" oninput="document.getElementById('lbl-energy').innerText = this.value + '%'">
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div id="focus-idle" class="text-center text-slate-500">
                        <i class="fa-regular fa-clock text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm">Ready to assess your focus state</p>
                    </div>

                    <div id="focus-result" class="hidden animate__animated animate__fadeInUp">
                        <div class="bg-white/5 border border-white/10 p-5 rounded-2xl mb-4">
                            <p id="focus-guidance" class="text-sm text-slate-200 leading-relaxed serif-font italic mb-3">--</p>
                            <div class="text-xs text-slate-500 flex justify-between pt-3 border-t border-white/5">
                                <span>Based on your state & context</span>
                                <span id="focus-timestamp">--</span>
                            </div>
                        </div>

                        <div id="suggestion-box" class="hidden mb-4 p-4 rounded-xl border bg-blue-500/10 border-blue-500/30">
                            <div class="flex items-start gap-3">
                                <i class="fa-solid fa-lightbulb text-xl text-blue-400"></i>
                                <div class="flex-1">
                                    <div class="text-xs font-bold uppercase mb-1 text-blue-400">Quick Boost</div>
                                    <div class="text-sm text-blue-200" id="suggestion-text">--</div>
                                </div>
                            </div>
                        </div>

                        <div id="trap-alert" class="hidden p-4 rounded-xl border">
                            <div class="flex items-start gap-3">
                                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                                <div class="flex-1">
                                    <div class="text-xs font-bold uppercase mb-1" id="trap-type">Alert</div>
                                    <div class="text-sm" id="trap-message">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-medium text-white/80">
                            <i class="fa-solid fa-receipt mr-2 text-violet-400"></i>Recent Transactions
                        </h3>
                        <button onclick="Finance.clearLog()" class="text-xs text-red-400 hover:text-red-300">Clear</button>
                    </div>
                    <div id="tx-log" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        
        <div class="glass-card rounded-3xl p-8 mb-8 animate__animated animate__fadeInUp">
            <h3 class="text-xl font-bold text-white mb-6 flex items-center justify-between">
                <span><i class="fa-solid fa-trophy mr-3 text-amber-400"></i>Achievements</span>
                <span class="text-sm text-slate-500" id="badge-count">0/8 Unlocked</span>
            </h3>
            <div class="grid grid-cols-4 md:grid-cols-8 gap-6">
                <div class="badge relative group cursor-pointer" data-badge="first-decline">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üõ°Ô∏è
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">First Victory</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-emerald-500/30">
                        Decline your first purchase
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="5-streak">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üî•
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Streak Master</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-orange-500/30">
                        Maintain 5-day streak
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="10k-saved">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üíé
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Money Saver</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-purple-500/30">
                        Save ‚Çπ10,000 total
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="willpower-hero">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üí™
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Willpower Hero</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-blue-500/30">
                        Score 80+ willpower
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="late-night">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üåô
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Night Owl</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-indigo-500/30">
                        Decline after 10 PM
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="mall-master">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-pink-500 to-rose-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        üõçÔ∏è
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Mall Master</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-pink-500/30">
                        Decline at shopping mall
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="perfect-week">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        ‚≠ê
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">Perfect Week</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-yellow-500/30">
                        7-day perfect streak
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
                
                <div class="badge relative group cursor-pointer" data-badge="ai-expert">
                    <div class="w-full aspect-square rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center text-4xl locked filter grayscale opacity-30 transition-all">
                        ü§ñ
                    </div>
                    <div class="text-xs text-center mt-2 text-slate-500 group-hover:text-white transition-colors">AI Expert</div>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 border border-violet-500/30">
                        Complete 50+ analyses
                        <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-3xl p-8 mb-8 animate__animated animate__fadeInUp">
            <h3 class="text-xl font-bold text-white mb-6">
                <i class="fa-solid fa-lightbulb mr-3 text-amber-400"></i>Smart Insights
            </h3>
            <div class="grid md:grid-cols-3 gap-4" id="insights-container">
                <div class="flex items-start gap-4 p-5 bg-blue-500/10 rounded-xl border border-blue-500/20 hover:border-blue-500/40 transition-all">
                    <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-chart-line text-blue-400 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-300 mb-1">Peak Vulnerability</p>
                        <p class="text-xs text-blue-200">Most vulnerable on <strong>Friday evenings</strong></p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-5 bg-purple-500/10 rounded-xl border border-purple-500/20 hover:border-purple-500/40 transition-all">
                    <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-location-dot text-purple-400 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-purple-300 mb-1">Location Trigger</p>
                        <p class="text-xs text-purple-200"><strong>Shopping malls</strong> trigger 3x more impulse buys</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-5 bg-emerald-500/10 rounded-xl border border-emerald-500/20 hover:border-emerald-500/40 transition-all">
                    <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-calendar-check text-emerald-400 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-emerald-300 mb-1">Best Day</p>
                        <p class="text-xs text-emerald-200">Willpower peaks on <strong>Mondays</strong> (avg 78%)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorial-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop" onclick="if(event.target === this) Tutorial.hide()">
        <div class="glass-card rounded-3xl p-8 max-w-3xl max-h-[90vh] overflow-y-auto m-4 animate__animated animate__zoomIn" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-2">üìö Quick Guide</h2>
                    <p class="text-sm text-slate-400">Learn how to use Twin Pulse effectively</p>
                </div>
                <button onclick="Tutorial.hide()" class="text-slate-400 hover:text-white text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-violet-300 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-keyboard"></i>
                    Keyboard Shortcuts
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/10">
                        <div class="w-12 h-12 rounded-lg bg-violet-500/20 flex items-center justify-center">
                            <kbd class="text-xl font-bold text-violet-300">A</kbd>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">Analyze Purchase</p>
                            <p class="text-xs text-slate-400">Quick AI analysis</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/10">
                        <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                            <kbd class="text-xl font-bold text-purple-300">C</kbd>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">Calculate Willpower</p>
                            <p class="text-xs text-slate-400">Get focus score</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/10">
                        <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center">
                            <kbd class="text-xl font-bold text-blue-300">?</kbd>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">Show Help</p>
                            <p class="text-xs text-slate-400">Open this modal</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-4 bg-white/5 rounded-xl border border-white/10">
                        <div class="w-12 h-12 rounded-lg bg-amber-500/20 flex items-center justify-center">
                            <i class="fa-solid fa-circle-question text-xl text-amber-300"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-white">Help Icon</p>
                            <p class="text-xs text-slate-400">Top right corner</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-fuchsia-300 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-rocket"></i>
                    How to Use Twin Pulse
                </h3>
                <div class="space-y-4">
                    <div class="flex gap-4 p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                        <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-white font-bold flex-shrink-0">1</div>
                        <div>
                            <h4 class="text-sm font-bold text-emerald-300 mb-1">üí∞ Set Your Financial Status</h4>
                            <p class="text-xs text-slate-300">Enter your current balance and savings goal. Select your mood and location.</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold flex-shrink-0">2</div>
                        <div>
                            <h4 class="text-sm font-bold text-blue-300 mb-1">üì∏ Analyze Purchases</h4>
                            <p class="text-xs text-slate-300">Upload a product image or enter details manually. AI will analyze if it's a smart buy.</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 p-4 bg-purple-500/10 rounded-xl border border-purple-500/20">
                        <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold flex-shrink-0">3</div>
                        <div>
                            <h4 class="text-sm font-bold text-purple-300 mb-1">üß† Track Willpower</h4>
                            <p class="text-xs text-slate-300">Enter your task, sleep, energy level. Get personalized focus guidance.</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 p-4 bg-amber-500/10 rounded-xl border border-amber-500/20">
                        <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center text-white font-bold flex-shrink-0">4</div>
                        <div>
                            <h4 class="text-sm font-bold text-amber-300 mb-1">üèÜ Earn Achievements</h4>
                            <p class="text-xs text-slate-300">Build streaks, unlock badges, and celebrate financial wins!</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold text-cyan-300 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sparkles"></i>
                    Key Features
                </h3>
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-brain text-violet-400"></i>
                        <span class="text-xs text-slate-300">AI-Powered Analysis</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-shield-heart text-emerald-400"></i>
                        <span class="text-xs text-slate-300">Impulse Risk Detection</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-trophy text-amber-400"></i>
                        <span class="text-xs text-slate-300">Achievement System</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-fire text-orange-400"></i>
                        <span class="text-xs text-slate-300">Streak Tracking</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-lightbulb text-yellow-400"></i>
                        <span class="text-xs text-slate-300">Smart Insights</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                        <i class="fa-solid fa-chart-line text-blue-400"></i>
                        <span class="text-xs text-slate-300">Progress Analytics</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 p-4 bg-gradient-to-r from-violet-500/10 to-fuchsia-500/10 rounded-xl border border-violet-500/20">
                <p class="text-sm text-center text-slate-300">
                    <i class="fa-solid fa-heart text-fuchsia-400 mr-2"></i>
                    Twin Pulse helps you make mindful financial decisions
                </p>
            </div>
        </div>
    </div>

    <script>
        console.log("Script loading...");
        const CONFIG = { model: "gemini-2.5-flash" };

        const Tutorial = {
            show: () => {
                document.getElementById('tutorial-modal').classList.remove('hidden');
            },
            hide: () => {
                document.getElementById('tutorial-modal').classList.add('hidden');
            }
        };

        const Auth = {
            user: null,
            init: () => { 
                const u = localStorage.getItem('twinUser'); 
                if(u){ Auth.user=JSON.parse(u); Auth.loadDash(); } 
            },
            toggle: () => { 
                document.getElementById('login-form').classList.toggle('hidden'); 
                document.getElementById('signup-form').classList.toggle('hidden'); 
                document.getElementById('login-msg').innerText=""; 
                document.getElementById('signup-msg').innerText=""; 
            },
            demoLogin: () => {
                const demoUser = { 
                    name: "Demo User", 
                    email: "demo@twinpulse.app", 
                    isDemo: true 
                };
                Auth.user = demoUser;
                localStorage.setItem('twinUser', JSON.stringify(demoUser));
                
                localStorage.setItem('twinTxLog', JSON.stringify([
                    {i:"Gaming Headset", p:2500},
                    {i:"Protein Shake", p:1200},
                    {i:"Movie Tickets", p:800}
                ]));
                
                Auth.loadDash();
                
                setTimeout(() => {
                    alert("üéâ Welcome to Demo Mode!\n\nExplore all features with sample data.\nYour demo session data will be cleared when you logout.");
                }, 500);
            },
            signup: (e) => {
                try {
                    console.log("Signup function called");
                    e.preventDefault();
                    console.log("Form submission prevented");
                    const name = document.getElementById('sign-name').value;
                    const email = document.getElementById('sign-email').value;
                    const pass = document.getElementById('sign-pass').value;
                    
                    if(!name || !email || !pass) {
                        Auth.showMsg("signup", "Please fill all fields.", "text-red-400");
                        return;
                    }
                    
                    const u = { name, email, pass };
                    console.log("User data:", u);
                    let db = JSON.parse(localStorage.getItem('twinDB'))||[];
                    console.log("Current DB:", db);
                    
                    if(db.find(x=>x.email===u.email)) {
                        console.log("Email already exists");
                        Auth.showMsg("signup", "Account already exists.", "text-red-400");
                        return;
                    }
                    
                    db.push(u); 
                    localStorage.setItem('twinDB', JSON.stringify(db));
                    console.log("Account created, new DB:", db);
                    Auth.showMsg("signup", "Account created! Please sign in.", "text-emerald-400"); 
                    setTimeout(() => Auth.toggle(), 1500);
                } catch(error) {
                    console.error("Signup error:", error);
                    Auth.showMsg("signup", "Error creating account: " + error.message, "text-red-400");
                }
            },
            login: (e) => {
                e.preventDefault();
                const e_in = document.getElementById('log-email').value, p_in = document.getElementById('log-pass').value;
                let db = JSON.parse(localStorage.getItem('twinDB'))||[];
                const u = db.find(x => x.email === e_in && x.pass === p_in);
                if(u) { Auth.user=u; localStorage.setItem('twinUser', JSON.stringify(u)); Auth.loadDash(); } 
                else Auth.showMsg("login", "Incorrect email or password.", "text-red-400");
            },
            loadDash: () => { 
                document.getElementById('auth-screen').classList.add('hidden'); 
                document.getElementById('dashboard').classList.remove('hidden'); 
                document.getElementById('display-name').innerText = `Hello, ${Auth.user.name.split(' ')[0]}`;
                document.getElementById('user-initial').innerText = Auth.user.name.charAt(0).toUpperCase(); 
                Finance.loadLog(); Finance.updateSafe();
                
                Stats.update();
                Stats.updateStreak();
                Badges.loadBadges();
                App.showToast(`Welcome back, ${Auth.user.name.split(' ')[0]}!`, 'success');
            },
            logout: () => { localStorage.removeItem('twinUser'); location.reload(); },
            showMsg: (form, msg, colorClass) => { 
                const el = document.getElementById(`${form}-msg`); 
                el.innerText = msg; 
                el.className = `text-center text-xs mt-4 ${colorClass}`; 
            },
            demoLogin: () => {
                Auth.user = {
                    name: "Demo User",
                    email: "demo@twinpulse.ai",
                    isDemo: true
                };
                localStorage.setItem('twinUser', JSON.stringify(Auth.user));
                
                const demoStats = {
                    totalSaved: 12450,
                    declined: 8,
                    streak: 3,
                    successRate: 73,
                    analyses: 11
                };
                localStorage.setItem('twinStats', JSON.stringify(demoStats));
                
                const demoBadges = ['first-decline', '5-streak'];
                localStorage.setItem('twinBadges', JSON.stringify(demoBadges));
                
                App.showToast("Demo mode activated! Explore all features.", "info", 4000);
                Auth.loadDash();
            }
        };

        const App = {
            showToast: (message, type = "info", duration = 3000) => {
                const container = document.getElementById('toast-container');
                const colors = {
                    success: 'bg-emerald-500 border-emerald-600',
                    error: 'bg-red-500 border-red-600',
                    info: 'bg-blue-500 border-blue-600',
                    warning: 'bg-amber-500 border-amber-600'
                };
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    info: 'info-circle',
                    warning: 'exclamation-triangle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl border-2`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-${icons[type]} text-xl"></i>
                        <span class="text-sm font-medium">${message}</span>
                    </div>
                `;
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            askGemini: async (prompt, img=null) => {
                const key = document.getElementById('api-key').value;
                if(!key) { throw new Error("API Key required"); }
                const payload = { contents: [{ parts: [{ text: prompt }, ...(img ? [{ inline_data: { mime_type: "image/jpeg", data: img } }] : [])] }] };
                
                console.log("Sending request to Gemini API...");
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${key}`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });
                
                const data = await res.json();
                console.log("API Response:", data);
                
                if(data.error) {
                    throw new Error(`API Error: ${data.error.message || JSON.stringify(data.error)}`);
                }
                
                if(!data.candidates || data.candidates.length === 0) {
                    throw new Error("No response generated. Content may have been filtered.");
                }
                
                const candidate = data.candidates[0];
                if(candidate.finishReason === 'SAFETY') {
                    throw new Error("Response blocked due to safety filters. Try rephrasing your request.");
                }
                
                const text = candidate?.content?.parts?.[0]?.text;
                if(!text) {
                    console.error("Unexpected response structure:", data);
                    throw new Error("Could not extract text from API response. Check console for details.");
                }
                
                console.log("Raw response text:", text);
                const clean = text.replace(/```json|```/g, '').trim();
                
                try {
                    return JSON.parse(clean);
                } catch(e) {
                    console.error("JSON parse error:", e);
                    console.error("Attempted to parse:", clean);
                    throw new Error("Could not parse API response as JSON. The AI may not have returned valid JSON format.");
                }
            }
        };

        const Stats = {
            update: () => {
                const data = JSON.parse(localStorage.getItem('twinStats')) || {
                    totalSaved: 0,
                    declined: 0,
                    streak: 0,
                    successRate: 0,
                    analyses: 0
                };
                
                document.getElementById('stat-saved').innerText = `‚Çπ${data.totalSaved}`;
                document.getElementById('stat-declined').innerText = data.declined;
                document.getElementById('stat-streak').innerText = data.streak;
                document.getElementById('stat-success').innerText = `${data.successRate}%`;
            },
            
            incrementDeclined: (amount) => {
                const data = JSON.parse(localStorage.getItem('twinStats')) || {totalSaved: 0, declined: 0, streak: 0, successRate: 0, analyses: 0};
                data.totalSaved += amount;
                data.declined += 1;
                const total = data.declined + data.analyses;
                data.successRate = total > 0 ? Math.round((data.declined / total) * 100) : 0;
                localStorage.setItem('twinStats', JSON.stringify(data));
                Stats.update();
                Badges.check('decline', {amount});
                App.showToast(`Purchase declined! Saved ‚Çπ${amount}`, 'success');
            },
            
            incrementAnalysis: () => {
                const data = JSON.parse(localStorage.getItem('twinStats')) || {totalSaved: 0, declined: 0, streak: 0, successRate: 0, analyses: 0};
                data.analyses += 1;
                localStorage.setItem('twinStats', JSON.stringify(data));
            },
            
            updateStreak: () => {
                const data = JSON.parse(localStorage.getItem('twinStats')) || {totalSaved: 0, declined: 0, streak: 0, successRate: 0, analyses: 0};
                const lastDate = localStorage.getItem('lastActiveDate');
                const today = new Date().toDateString();
                
                if(lastDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if(lastDate === yesterday.toDateString()) {
                        data.streak += 1;
                        if(data.streak === 5) Badges.check('streak-5');
                        if(data.streak === 7) Badges.check('perfect-week');
                    } else if(lastDate) {
                        data.streak = 1;
                    }
                    
                    localStorage.setItem('lastActiveDate', today);
                    localStorage.setItem('twinStats', JSON.stringify(data));
                    Stats.update();
                }
            }
        };

        const Finance = {
            mode: 'visual',
            imgBase64: null,
            stream: null,
            lastRes: null,
            updateSafe: () => {
                const b = parseFloat(document.getElementById('fin-bal').value), g = parseFloat(document.getElementById('fin-goal').value);
                const s = b - g;
                const el = document.getElementById('fin-safe'); 
                el.innerText = s<0 ? `Deficit: ‚Çπ${Math.abs(s)}` : `‚Çπ${s}`; 
                el.className = s<0 ? "text-lg font-medium text-rose-400" : "text-lg font-medium text-emerald-400";
            },
            setMood: (btn, m) => { document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); document.getElementById('fin-mood').value = m; },
            toggleMode: (m) => {
                Finance.mode = m;
                const btnVis = document.getElementById('btn-mode-vis');
                const btnTxt = document.getElementById('btn-mode-txt');
                if(m === 'visual') {
                    btnVis.classList.replace('text-slate-400', 'text-white'); btnVis.classList.add('bg-white/10');
                    btnTxt.classList.replace('text-white', 'text-slate-400'); btnTxt.classList.remove('bg-white/10');
                } else {
                    btnTxt.classList.replace('text-slate-400', 'text-white'); btnTxt.classList.add('bg-white/10');
                    btnVis.classList.replace('text-white', 'text-slate-400'); btnVis.classList.remove('bg-white/10');
                }
                document.getElementById('mode-visual').classList.toggle('hidden', m!=='visual');
                document.getElementById('mode-text').classList.toggle('hidden', m!=='text');
                if(m==='text') Finance.stopCamera();
            },
            handleUpload: (input) => {
                if(input.files && input.files[0]) {
                    Finance.stopCamera(); 
                    const r = new FileReader();
                    r.onload = (e) => {
                        Finance.imgBase64 = e.target.result.split(',')[1];
                        const display = document.getElementById('display-image');
                        display.src = e.target.result; display.classList.remove('hidden');
                        document.getElementById('visual-placeholder').classList.add('hidden');
                        document.getElementById('camera-feed').classList.add('hidden'); document.getElementById('btn-capture').classList.add('hidden');
                    };
                    r.readAsDataURL(input.files[0]);
                }
            },
            startCamera: async () => {
                try {
                    const video = document.getElementById('camera-feed');
                    Finance.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = Finance.stream; video.classList.remove('hidden');
                    document.getElementById('display-image').classList.add('hidden'); document.getElementById('visual-placeholder').classList.add('hidden'); document.getElementById('btn-capture').classList.remove('hidden');
                } catch(e) { alert("Camera access required."); }
            },
            snapPhoto: () => {
                if(!Finance.stream) return;
                const video = document.getElementById('camera-feed');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const dataUrl = canvas.toDataURL('image/jpeg');
                Finance.imgBase64 = dataUrl.split(',')[1];
                const display = document.getElementById('display-image');
                display.src = dataUrl; display.classList.remove('hidden');
                Finance.stopCamera(); video.classList.add('hidden'); document.getElementById('btn-capture').classList.add('hidden');
            },
            stopCamera: () => { if(Finance.stream) { Finance.stream.getTracks().forEach(t => t.stop()); Finance.stream = null; } },
            analyze: async () => {
                const btn = document.getElementById('btn-fin-analyze');
                try {
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Thinking...'; btn.disabled = true;

                    const bal = document.getElementById('fin-bal').value, goal = document.getElementById('fin-goal').value;
                    const mood = document.getElementById('fin-mood').value, loc = document.getElementById('fin-loc').value;
                    let txt = "Analyze visual.";
                    if(Finance.mode === 'text') txt = `Item: ${document.getElementById('man-name').value}, Price: ${document.getElementById('man-price').value}`;
                    else if(!Finance.imgBase64) throw new Error("Please select an image.");

                    const p = `Persona: Empathetic, Minimalist Financial Wellness Coach. 
                    Context: Balance ‚Çπ${bal}, Goal ‚Çπ${goal}, Mood ${mood}, Loc ${loc}, Input: ${txt}. 
                    Task: Identify item & price. Calc Impulse Risk(0-100).
                    Rules: 
                    1. If (Balance-Price < Goal) VERDICT="DENIED". Reason: Gentle reminder about the savings goal.
                    2. If Risk>70 VERDICT="CAUTION".
                    3. Else "APPROVED".
                    Output JSON only: { "item": "str", "price": num, "risk": num, "verdict": "APPROVED"|"DENIED"|"CAUTION", "reason": "gentle_mindful_sentence" }`;

                    const res = await App.askGemini(p, Finance.mode==='visual'?Finance.imgBase64:null);
                    Finance.lastRes = res;

                    Stats.incrementAnalysis();

                    document.getElementById('fin-idle').classList.add('hidden');
                    document.getElementById('fin-result').classList.remove('hidden');
                    document.getElementById('fin-result').classList.add('flex');

                    document.getElementById('res-name').innerText = res.item;
                    document.getElementById('res-price').innerText = `‚Çπ${res.price}`;
                    document.getElementById('res-risk-val').innerText = res.risk+"%";
                    document.getElementById('res-risk-bar').style.width = res.risk+"%";
                    document.getElementById('res-reason').innerText = `"${res.reason}"`;

                    const wage = parseFloat(document.getElementById('fin-wage').value) || 100;
                    const hours = (res.price / wage).toFixed(1);
                    document.getElementById('res-time-cost').innerText = `‚è±Ô∏è ${hours} hours of work required`;

                    const badge = document.getElementById('res-badge');
                    const conf = document.getElementById('btn-confirm');
                    
                    if(res.verdict==='APPROVED'){
                        badge.innerText = "Mindful Choice"; badge.className="px-3 py-1 bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 rounded-full text-[10px] font-bold uppercase tracking-wide";
                        conf.disabled=false; conf.innerText="Confirm Purchase"; conf.className="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-white font-medium rounded-2xl text-xs uppercase tracking-wider transition-colors shadow-lg shadow-emerald-500/20";
                        App.showToast("‚úì Smart purchase approved!", "success");
                    } else if(res.verdict==='DENIED') {
                        badge.innerText = "Beyond Goal"; badge.className="px-3 py-1 bg-rose-500/20 text-rose-300 border border-rose-500/30 rounded-full text-[10px] font-bold uppercase tracking-wide";
                        conf.disabled=true; conf.innerText="Purchase Blocked"; conf.className="w-full py-4 bg-white/5 text-slate-500 font-medium rounded-2xl text-xs uppercase tracking-wider cursor-not-allowed";
                        Stats.incrementDeclined(res.price);
                        Badges.check('decline', {amount: res.price, location: loc});
                        App.showToast("üõ°Ô∏è Purchase blocked - Goal protected!", "warning");
                    } else {
                        badge.innerText = "High Impulse"; badge.className="px-3 py-1 bg-amber-500/20 text-amber-300 border border-amber-500/30 rounded-full text-[10px] font-bold uppercase tracking-wide";
                        conf.disabled=false; conf.innerText="Proceed with Caution"; conf.className="w-full py-4 bg-amber-500 hover:bg-amber-400 text-white font-medium rounded-2xl text-xs uppercase tracking-wider transition-colors shadow-lg shadow-amber-500/20";
                        App.showToast("‚ö†Ô∏è High impulse risk detected!", "warning");
                    }
                } catch(e) { 
                    console.error("Analysis error:", e);
                    App.showToast(e.message || "Analysis failed", "error");
                } finally { btn.innerText = "Analyze Decision"; btn.disabled = false; }
            },
            confirm: () => {
                if(!Finance.lastRes) return;
                const b = parseFloat(document.getElementById('fin-bal').value), n = b - Finance.lastRes.price;
                document.getElementById('fin-bal').value = n; Finance.updateSafe();
                const log = JSON.parse(localStorage.getItem('twinTxLog'))||[];
                log.unshift({i:Finance.lastRes.item, p:Finance.lastRes.price});
                localStorage.setItem('twinTxLog', JSON.stringify(log));
                Finance.loadLog();
                const btn = document.getElementById('btn-confirm');
                btn.disabled=true; btn.innerText="Saved to Journal";
            },
            loadLog: () => {
                const log = JSON.parse(localStorage.getItem('twinTxLog'))||[];
                const c = document.getElementById('tx-log'); c.innerHTML="";
                if(!log.length) c.innerHTML = `<p class="text-center text-xs text-slate-500 mt-6 italic">No recent activity.</p>`;
                log.forEach(x => { c.innerHTML += `<div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 transition-colors"><span class="text-sm text-slate-200">${x.i}</span><span class="text-xs text-rose-300 font-medium">-‚Çπ${x.p}</span></div>`; });
            },
            clearLog: () => { localStorage.removeItem('twinTxLog'); Finance.loadLog(); }
        };

        const Badges = {
            unlock: (badgeId) => {
                const badges = JSON.parse(localStorage.getItem('twinBadges')) || [];
                if(badges.includes(badgeId)) return;
                
                badges.push(badgeId);
                localStorage.setItem('twinBadges', JSON.stringify(badges));
                
                const badge = document.querySelector(`[data-badge="${badgeId}"] > div`);
                if(badge) {
                    badge.classList.remove('locked', 'grayscale', 'opacity-30');
                    badge.classList.add('badge-unlock');
                }
                
                Badges.throwConfetti();
                
                const badgeNames = {
                    'first-decline': 'üõ°Ô∏è First Victory',
                    '5-streak': 'üî• Streak Master',
                    '10k-saved': 'üíé Money Saver',
                    'willpower-hero': 'üí™ Willpower Hero',
                    'late-night': 'üåô Night Owl',
                    'mall-master': 'üõçÔ∏è Mall Master',
                    'perfect-week': '‚≠ê Perfect Week',
                    'ai-expert': 'ü§ñ AI Expert'
                };
                
                App.showToast(`Achievement Unlocked: ${badgeNames[badgeId]}!`, 'success', 5000);
                Badges.updateCount();
            },
            
            updateCount: () => {
                const badges = JSON.parse(localStorage.getItem('twinBadges')) || [];
                document.getElementById('badge-count').innerText = `${badges.length}/8 Unlocked`;
            },
            
            loadBadges: () => {
                const badges = JSON.parse(localStorage.getItem('twinBadges')) || [];
                badges.forEach(badgeId => {
                    const badge = document.querySelector(`[data-badge="${badgeId}"] > div`);
                    if(badge) {
                        badge.classList.remove('locked', 'grayscale', 'opacity-30');
                    }
                });
                Badges.updateCount();
            },
            
            throwConfetti: () => {
                const colors = ['#a78bfa', '#f472b6', '#60a5fa', '#34d399', '#fbbf24'];
                for(let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 30);
                }
            },
            
            check: (type, data = {}) => {
                const stats = JSON.parse(localStorage.getItem('twinStats')) || {};
                const badges = JSON.parse(localStorage.getItem('twinBadges')) || [];
                
                if(type === 'decline' && !badges.includes('first-decline')) {
                    Badges.unlock('first-decline');
                }
                if(stats.streak >= 5 && !badges.includes('5-streak')) {
                    Badges.unlock('5-streak');
                }
                if(stats.totalSaved >= 10000 && !badges.includes('10k-saved')) {
                    Badges.unlock('10k-saved');
                }
                if(type === 'willpower' && data.score >= 80 && !badges.includes('willpower-hero')) {
                    Badges.unlock('willpower-hero');
                }
                if(type === 'decline' && data.location === 'Shopping Mall' && !badges.includes('mall-master')) {
                    Badges.unlock('mall-master');
                }
                const hour = new Date().getHours();
                if(type === 'decline' && (hour >= 22 || hour <= 4) && !badges.includes('late-night')) {
                    Badges.unlock('late-night');
                }
                if(stats.streak >= 7 && !badges.includes('perfect-week')) {
                    Badges.unlock('perfect-week');
                }
                if(stats.analyses >= 50 && !badges.includes('ai-expert')) {
                    Badges.unlock('ai-expert');
                }
            }
        };

        const Focus = {
            checkReady: () => {
                const task = document.getElementById('current-task').value;
                const btn = document.getElementById('btn-focus');
                if(task.trim()) {
                    btn.classList.add('btn-glow-ready');
                } else {
                    btn.classList.remove('btn-glow-ready');
                }
            },
            calculate: async () => {
                const btn = document.getElementById('btn-focus');
                const sleep = parseFloat(document.getElementById('sleep-hours').value) || null;
                const tasksComplete = parseInt(document.getElementById('tasks-completed').value) || 0;
                const tasksTotal = parseInt(document.getElementById('tasks-total').value) || 1;
                const badDecisions = parseInt(document.getElementById('bad-decisions').value) || null;
                const task = document.getElementById('current-task').value;
                const prevActivity = document.getElementById('prev-activity').value;
                const energy = document.getElementById('energy-level').value;

                if(!task) return alert("Please enter your current task/goal");

                try {
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Analyzing...'; 
                    btn.disabled = true;

                    const now = new Date(); 
                    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const p = `You are a mindful productivity and willpower coach. Analyze the user's current state comprehensively.

Context:
- Current Task/Goal: "${task}"
- Time: ${timeString}
- Sleep: ${sleep !== null ? sleep + ' hrs (optimal: 7-9)' : 'Not provided'}
- Task Completion Rate: ${tasksComplete}/${tasksTotal}
- Bad Decisions Today: ${badDecisions !== null ? badDecisions : 'Not provided'}
- Previous Activity: ${prevActivity}
- Energy Level: ${energy}%

Calculate:
1. Willpower Score (0-100) using formula:
   ${sleep !== null ? '- Sleep: 7-9 hrs = +30, <6 hrs = -20, >9 hrs = -10' : '- Sleep not provided, skip this factor'}
   - Task completion: (completed/total) * 40
   ${badDecisions !== null ? '- Bad decisions: each = -10' : '- Bad decisions not provided, skip this factor'}
   - Energy level: Use as additional context for overall assessment
   - Base: 50
   - If sleep or bad decisions are not provided, calculate based on available factors and normalize to 0-100 scale

2. If Willpower < 40, predict likely trap: "Late Night Shopping", "Social FOMO", "Stress Spending", "Boredom Browse"

3. If Willpower < 50, provide a SPECIFIC actionable suggestion based on what's low:
   ${sleep !== null ? '- If sleep < 6.5 hrs: Suggest quick nap (15-20 min) or going to bed early tonight' : ''}
   - If energy < 40%: Suggest coffee, quick walk, or light snack
   - If tasks completion low: Suggest starting with one small task to build momentum
   ${badDecisions !== null ? '- If bad decisions high: Suggest avoiding triggers, using cash only, or asking a friend to hold you accountable' : ''}
   - If previous activity was "Doomscrolling" or "Gaming": Suggest 5-min meditation or stretching to reset
   
4. Provide calm, encouraging guidance paragraph (3-4 sentences) that addresses:
   - Their current willpower state
   - How previous activity affects focus
   - Realistic advice for the task ahead
   - Time-appropriate suggestions
   - Acknowledge if some data wasn't provided and work with what you have

Output JSON only:
{
  "score": number (0-100),
  "status": "High" | "Medium" | "Low",
  "guidance": "warm_encouraging_paragraph_with_specific_advice",
  "trap": "trap_type or null",
  "trap_message": "specific_warning or null",
  "suggestion": "specific_actionable_tip_if_score_below_50 or null"
}`;

                    const res = await App.askGemini(p);
                    
                    Badges.check('willpower', {score: res.score});
                    
                    document.getElementById('willpower-score').innerText = res.score;
                    document.getElementById('willpower-bar').style.width = res.score + '%';
                    document.getElementById('willpower-status').innerText = res.status;

                    if(res.score >= 70) {
                        App.showToast(`üí™ Great willpower: ${res.score}!`, 'success');
                    } else if(res.score < 40) {
                        App.showToast(`‚ö†Ô∏è Low willpower - Be careful!`, 'warning');
                    }

                    document.getElementById('focus-idle').classList.add('hidden');
                    document.getElementById('focus-result').classList.remove('hidden');
                    document.getElementById('focus-guidance').innerText = `"${res.guidance}"`;
                    document.getElementById('focus-timestamp').innerText = `Checked at ${timeString}`;

                    const suggestionBox = document.getElementById('suggestion-box');
                    if(res.suggestion && res.score < 50) {
                        suggestionBox.classList.remove('hidden');
                        document.getElementById('suggestion-text').innerText = res.suggestion;
                    } else {
                        suggestionBox.classList.add('hidden');
                    }

                    const trapAlert = document.getElementById('trap-alert');
                    if(res.trap) {
                        trapAlert.classList.remove('hidden');
                        trapAlert.className = "p-4 rounded-xl border bg-amber-500/10 border-amber-500/30 text-amber-300";
                        document.getElementById('trap-type').innerText = res.trap;
                        document.getElementById('trap-message').innerText = res.trap_message;
                    } else {
                        trapAlert.classList.add('hidden');
                    }

                } catch(e) { 
                    alert(e.message); 
                } finally { 
                    btn.innerHTML = '<i class="fa-solid fa-calculator mr-1"></i>Calculate'; 
                    btn.disabled = false; 
                }
            }
        };

        console.log("Auth object created:", Auth);
        console.log("Initializing Auth...");
        Auth.init();
        console.log("Auth initialized. Ready!");

        document.addEventListener('keydown', (e) => {
            if(document.getElementById('dashboard').classList.contains('hidden')) return;
            
            const activeElement = document.activeElement;
            if(activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT')) {
                return;
            }
            
            if(e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                const analyzeBtn = document.getElementById('btn-fin-analyze');
                if(analyzeBtn && !analyzeBtn.disabled) {
                    analyzeBtn.click();
                    App.showToast("‚å®Ô∏è Shortcut: 'A' to Analyze", "info", 2000);
                }
            }
            
            if(e.key === 'c' || e.key === 'C') {
                e.preventDefault();
                const focusBtn = document.getElementById('btn-focus');
                if(focusBtn && !focusBtn.disabled) {
                    focusBtn.click();
                    App.showToast("‚å®Ô∏è Shortcut: 'C' to Calculate", "info", 2000);
                }
            }
            
            if(e.key === '?') {
                e.preventDefault();
                Tutorial.show();
            }
        });
    </script>
</body>
</html>
